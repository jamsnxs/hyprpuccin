#!/bin/bash
# New version by Grok
# Arquivo de bloqueio para evitar execuções simultâneas
LOCKFILE="/tmp/theme-switch.lock"
if [ -e "$LOCKFILE" ]; then
    echo "Erro: Script já em execução." >&2
    exit 1
fi
touch "$LOCKFILE"

# Garantir que o lockfile seja removido ao sair
trap 'rm -f "$LOCKFILE"' EXIT

# Diretório base para configurações
CONFIG_DIR="$HOME/.config"
PICTURES_DIR="$HOME/Pictures/hyprland"

# Arquivos de configuração
CONFIG_FILES=(
    "$CONFIG_DIR/alacritty/alacritty.toml"
    "$CONFIG_DIR/btop/btop.conf"
    "$CONFIG_DIR/hypr/hyprland.conf"
    "$CONFIG_DIR/waybar/style.css"
    "$CONFIG_DIR/zathura/zathurarc"
    "$CONFIG_DIR/tmux/tmux.conf"
)

# Configurações dos temas
declare -A DARK_THEME=(
    [alacritty]="catppuccin-frappe.toml"
    [btop]="$CONFIG_DIR/btop/themes/catppuccin_frappe.theme"
    [zathura]="catppuccin-frappe"
    [tmux]="frappe"
    [gtk]="Graphite-teal-Dark-nord"
    [icon]="Reversal-orange-dark"
    [color_scheme]="prefer-dark"
    [wallpaper]="$PICTURES_DIR/dark.png"
    [border]="col.active_border = rgba(7BA3F7EE) rgba(F7768EEE) 50deg"
    [waybar_colors]="s|#e1a5a6|#77b5a6|g;s|#db6d5a|#7899df|g"
)

declare -A LIGHT_THEME=(
    [alacritty]="catppuccin-latte.toml"
    [btop]="$CONFIG_DIR/btop/themes/catppuccin_latte.theme"
    [zathura]="catppuccin-latte"
    [tmux]="latte"
    [gtk]="Graphite-teal-Light-nord"
    [icon]="Reversal-orange"
    [color_scheme]="prefer-light"
    [wallpaper]="$PICTURES_DIR/light.png"
    [border]="col.active_border = rgba(E1A5A6EE) rgba(DFFF00EE) 50deg"
    [waybar_colors]="s|#77b5a6|#e1a5a6|g;s|#7899df|#db6d5a|g"
)

# Função para verificar a existência de arquivos
check_config_files() {
    for file in "${CONFIG_FILES[@]}"; do
        if [ ! -e "$file" ]; then
            echo "Erro: Arquivo de configuração não encontrado: $file" >&2
            exit 1
        fi
    done
}

# Função para aplicar o tema
apply_theme() {
    local theme_name="$1"
    local -n theme_ref="$2" # Referência ao array do tema

    # Validar tema
    if [[ "$theme_name" != "dark" && "$theme_name" != "light" ]]; then
        echo "Erro: Tema inválido. Use 'dark' ou 'light'." >&2
        exit 1
    fi

    # Atualizar configurações
    sed -i "s|catppuccin-.*.toml|${theme_ref[alacritty]}|" "${CONFIG_FILES[0]}"
    sed -i "s|color_theme = .*|color_theme = \"${theme_ref[btop]}\"|" "${CONFIG_FILES[1]}"
    sed -i "s|include catppuccin-.*|include ${theme_ref[zathura]}|" "${CONFIG_FILES[4]}"
    sed -i "s|col.active_border = .*|${theme_ref[border]}|" "${CONFIG_FILES[2]}"
    sed -i "${theme_ref[waybar_colors]}" "${CONFIG_FILES[3]}"
    sed -i "s|set -g @catppuccin_flavor \".*\"|set -g @catppuccin_flavor \"${theme_ref[tmux]}\"|" "${CONFIG_FILES[5]}"

    # Aplicar configurações do GNOME em segundo plano
    gsettings set org.gnome.desktop.interface gtk-theme "${theme_ref[gtk]}" &
    gsettings set org.gnome.desktop.interface icon-theme "${theme_ref[icon]}" &
    gsettings set org.gnome.desktop.interface color-scheme "${theme_ref[color_scheme]}" &

    # Aplicar papel de parede
    swww img "${theme_ref[wallpaper]}" --transition-step 80 --transition-fps 80 \
        --transition-type any --transition-duration 1 &

    # Recarregar configuração do tmux
    tmux source "${CONFIG_FILES[5]}" &

    wait # Aguardar conclusão dos processos em segundo plano
}

# Verificar existência dos arquivos
check_config_files

# Determinar tema atual e alternar
if grep -q "catppuccin-latte.toml" "${CONFIG_FILES[0]}"; then
    apply_theme "dark" DARK_THEME
else
    apply_theme "light" LIGHT_THEME
fi